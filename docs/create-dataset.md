# 学習用データ作成

`tools/dataset_converter/`以下に、収集した画像から学習用のデータセットを作成ための補助ツールが実装されている。

## 1. 顔部分の切り出し

必要なパッケージがインストールされたvirtualenvを有効化した状態で、  
画像収集ツールで収集された画像の親ディレクトリを第一引数に、`extract_face.py`を実行する。  
`python extract_face.py <画像ディレクトリ>`

OpenCVのカスケード分類器で画像から顔の部分だけが取り出され、`<画像ディレクトリ>_raw_faces`以下に出力される。

## 2. データのクレンジング

機械的に取り出した顔画像は教師データとして不適切なものも多いため、  
不要な画像を目視確認して削除する。具体的には

* 顔の画像ではない
* 別人の画像である
* 本人であることが特定できない
    - 大きく加工された画像
    - 特殊メイク
    - 顔の一部が隠されている
    - 解像度が非常に低い

などの画像を除外する。

## 3. 学習用データセットの作成

以下の処理を行い、画像をデータセットに変換する。  

* 画像サイズを揃える。CNNモデルの都合上、現在処理可能なのは100x100のみ
* ラベルを0から始まる整数の連番に変換する
* クラス数を調整する
* 学習用データと評価用に分割する

変換設定をJSONファイルに記載し、`img2dataset.py`の第一引数に与えて実行する。  
`python img2dataset.py <設定ファイル>`

```JSON
{
    "orig_data_dir": "cleaned_data_dir",
    "img_size": 100,
    "test_ratio": 0.2,
    "num_class": null
}
```

設定項目の意味は

* orig_data_dir
    - クレンジング済みデータのパス
* img_size
    - 変換後の顔画像の1辺の画素数
    - 前述の通り、現在は100以外を指定できない
* test_ratio
    - 全体のうち評価用データに振り分ける割合
* num_class
    - クラス数を指定すると、元データからランダムに`num_class`種類のラベルだけを選択してデータセットを作成する
    - `null`, 無指定の場合は全ラベルを使ってデータセットを作成する

作成されたデータセットは以下の形式で出力される。

```
dataset/100x100_${num_class}/
   |- train/  # 学習用データ
   |- test/   # 評価用データ
   |- label_table.tsv  # 元のラベルと変換後のラベルの対応表
```
